"use strict";angular.module("app").component("statistic",{templateUrl:"app/modules/statistic/statistic.html?rev=1f61e47b8a",controller:["$rootScope","$window","$templateCache","$q","$api","$filter","$timeout","$stateParams","uiGridConstants","i18nService","$scope",function(e,t,i,a,r,n,l,s,d,o,m){var c=this,p=APP.Project[0]._id,h={project:[]};angular.forEach(e.Project,function(e){h.project.push({id:e._id})}),o.add("zh-cn",{aggregation:{sum:"合计："}}),c.gridOptions={onRegisterApi:function(e){c.gridApi=e,c.departmentreport&&l(function(){e.grouping&&e.grouping.clearGrouping(),e.grouping&&e.grouping.groupColumn("title"),e.core.notifyDataChange(d.dataChange.COLUMN)})},enableColumnMenus:!1,enableRowSelection:!1,enableGroupHeaderSelection:!1,enableRowHeaderSelection:!1,enableSorting:!0,rowHeight:34,enableColumnResizing:!0,exporterOlderExcelCompatibility:!0,exporterFieldCallback:function(e,t,i,a){return{name:!0,"id.substr(12,12)":!0,"channeldid.substr(12,12)":!0}[i.field]?'="'+(a||"")+'"':a},showColumnFooter:!0,treeRowHeaderAlwaysVisible:!0},c.tabClick=function(e){c.startDate=function(){return"dailyreport"===e?moment().format("YYYY-MM-DD"):moment().subtract(30,"days").format("YYYY-MM-DD")}(),c.endDate=moment().format("YYYY-MM-DD"),c.rangeDay={settlereport:183,monthlyreport:31}[e]||0,c.tabActive=e,c.report(e)},c.report=function(e){var t=c.billingserviceData&&c.billingserviceData.selected&&c.billingserviceData.selected.id;switch(h.project&&(h.project=[]),angular.forEach(APP.Project,function(e){h.project.push({id:e._id,billingservice:t||void 0})}),e){case"settlereport":case"monthlyreport":case"projectreport":h.from=c.startDate.replace(/\-/g,""),h.to=c.endDate.replace(/\-/g,"");break;case"dailyreport":h.time=c.startDate.replace(/\-/g,"");break;case"departmentreport":h.from=c.startDate.replace(/\-/g,""),h.to=c.endDate.replace(/\-/g,"")}switch(e){case"settlereport":c.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,pinnedLeft:!0,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"智能仪表名称",name:"name",width:"*",pinnedLeft:!0,minWidth:200},{displayName:"通道名称",name:"channelname",width:"*",minWidth:200},{displayName:moment(c.startDate).format("YYYY年M月D日"),name:"min",type:"number",width:"*",minWidth:140,cellClass:"text-right",headerCellClass:"text-right"},{displayName:moment(c.endDate).format("YYYY年M月D日"),name:"max",type:"number",width:"*",minWidth:140,cellClass:"text-right",headerCellClass:"text-right"},{displayName:"能耗总值",name:"sum",type:"number",width:"*",minWidth:130,cellClass:"text-right",aggregationType:d.aggregationTypes.sum,filters:[{condition:d.filter.GREATER_THAN,placeholder:"大于"},{condition:d.filter.LESS_THAN,placeholder:"小于"}],headerCellClass:"text-right grid-cell-50",footerCellFilter:"number:2"},{displayName:"单价",name:"price",type:"number",width:"*",minWidth:100,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"倍率系数",name:"comi",type:"number",width:"*",minWidth:100,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"费用",name:"cost",type:"number",width:"*",minWidth:130,cellClass:"text-right",aggregationType:d.aggregationTypes.sum,filters:[{condition:d.filter.GREATER_THAN,placeholder:"大于"},{condition:d.filter.LESS_THAN,placeholder:"小于"}],headerCellClass:"text-right grid-cell-50",footerCellFilter:"number:2"}];break;case"monthlyreport":c.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,pinnedLeft:!0,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"智能仪表名称",name:"name",width:"*",pinnedLeft:!0,minWidth:180},{displayName:"通道名称",name:"channelname",width:"*",minWidth:200},{displayName:"月能耗",type:"number",name:"monthlySum",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"日平均",type:"number",name:"dailyAvg",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"}];break;case"dailyreport":c.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,pinnedLeft:!0,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"智能仪表名称",name:"name",width:"*",pinnedLeft:!0,minWidth:200},{displayName:"通道名称",name:"channelname",width:"*",minWidth:200},{displayName:"日能耗",type:"number",name:"dailysum",width:"*",minWidth:70,headerCellClass:"text-right",cellClass:"text-right"}];break;case"projectreport":c.gridOptions.columnDefs=[{displayName:"",name:"$index",type:"number",width:50,minWidth:50,enableColumnMenu:!1,exporterSuppressExport:!0,headerCellClass:"text-center",headerCellTemplate:'<div class="ui-grid-cell-contents">序号</div>',cellClass:"text-center",cellTemplate:'<div class="ui-grid-cell-contents" ng-bind="grid.renderContainers.body.visibleRowCache.indexOf(row)+1"></div>'},{displayName:"项目名称",name:"name",width:"*",minWidth:260},{displayName:"总用能",type:"number",name:"consumption",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"总费用",type:"number",name:"cost",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单位用能",type:"number",name:"uaec",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单位电能",type:"number",name:"uaeec",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"}];break;case"departmentreport":c.gridOptions.columnDefs=[{displayName:"商户名称",name:"title",width:"*",minWidth:260,grouping:{groupPriority:0},sort:{priority:0}},{displayName:"智能仪表名称",type:"number",name:"sensor.title",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"期初读数",type:"number",name:"sensor.from",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:" 期末读数",type:"number",name:"sensor.to",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"用量",type:"number",name:"sensor.usage",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"单价",type:"number",name:"sensor.price",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"},{displayName:"费用",type:"number",name:"sensor.cost",width:"*",minWidth:160,headerCellClass:"text-right",cellClass:"text-right"}]}r.business[e](h,function(t){switch(e){case"departmentreport":t=t.result[p]||{},c.statistic=t.statistic||{},t=t.detail||[],c.group=[],angular.forEach(t,function(e){e.sensors.length?angular.forEach(e.sensors,function(t,i){var a={};angular.copy(e,a),a.sensor=t,c.group.push(a)}):c.group.push(e)}),t=c.group,l(function(){c.gridApi.treeBase.expandAllRows()},1e3);break;case"settlereport":t=t.result[p]||{},c.statistic=t.statistic||{},t=t.detail||[],c.gridOptions.columnDefs.unshift({displayName:"设备ID",name:"id.substr(12,12)",type:"number",width:"*",minWidth:120}),c.gridOptions.columnDefs.push({displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100});break;case"monthlyreport":t=t.result[p]||[],t.length&&(angular.forEach(t[0].usage,function(e,t){this.push({displayName:n("date")(t,"M-d"),name:"day"+n("date")(t,"yyyyMMdd"),width:"*",minWidth:60,headerCellClass:"text-right",cellClass:"text-right"})},c.gridOptions.columnDefs),c.gridOptions.columnDefs.unshift({displayName:"设备ID",type:"number",name:"channeldid.substr(12,12)",width:"*",minWidth:120}),c.gridOptions.columnDefs.push({displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100}));break;case"dailyreport":t=t.result[p]||[],t.length&&angular.forEach(t[0].usage,function(e,t){t=n("date")(t,"H"),this.push({displayName:t+"时",name:"hour"+t,width:"*",minWidth:50,headerCellClass:"text-right",cellClass:"text-right"})},c.gridOptions.columnDefs),c.gridOptions.columnDefs.unshift({displayName:"设备ID",type:"number",name:"channeldid.substr(12,12)",width:"*",minWidth:120}),c.gridOptions.columnDefs.push({displayName:"设备编码",name:"tag",width:"*",minWidth:160,enableColumnMenu:!1},{displayName:"能耗分类",name:"energy",width:"*",minWidth:100});break;case"projectreport":angular.forEach(t.result,function(e){angular.forEach(e,function(t,i){e[i]="name"===i?t:Math.round(100*t)/100}),this.push(e)},t=[])}c.rebuildData(t)})},r.billingservice.info({project:APP.Project.ids},function(e){angular.forEach(e.result||{},function(e){this.push(e)},c.billingserviceData=[])});var u=a.defer();return u=r.business.departmentreport({project:[{check:!0,id:p}]},function(e){e=e.result[p]}).$promise,u.then(function(){}).finally(function(){c.tabs={settlereport:"结算报表",monthlyreport:"月报表",dailyreport:"日报表"},c.tabClick(s.tab||"settlereport")}),c.filter=function(){c.gridOptions.enableFiltering=!c.gridOptions.enableFiltering,c.gridApi.core.notifyDataChange(d.dataChange.COLUMN)},c.export=function(){switch(c.tabActive){case"settlereport":case"monthlyreport":case"projectreport":c.gridOptions.exporterCsvFilename=document.title+"_统计_"+c.tabs[c.tabActive]+"_"+c.startDate.replace(/\-/g,"")+"_"+c.endDate.replace(/\-/g,"")+".csv";break;case"dailyreport":case"departmentreport":c.gridOptions.exporterCsvFilename=document.title+"_统计_"+c.tabs[c.tabActive]+"_"+c.startDate.replace(/\-/g,"")+".csv"}c.gridApi.exporter.csvExport("visible","visible",angular.element(document.querySelectorAll(".subContent")))},(c.grid_timetype=function(e){c.grid_timetype_current=e,c.rebuildData&&c.rebuildData(c.gridOptions.data)})("usage"),c.rebuildData=function(e){"monthlyreport"===c.tabActive&&angular.forEach(e,function(e){e.monthlySum=Math.round(100*e.monthlySum)/100,angular.forEach(e[c.grid_timetype_current],function(t,i){e["day"+n("date")(i,"yyyyMMdd")]=t})}),"dailyreport"===c.tabActive&&angular.forEach(e,function(e){e.dailysum=Math.round(100*e.dailysum)/100,angular.forEach(e[c.grid_timetype_current],function(t,i){e["hour"+n("date")(i,"H")]=t})}),c.gridOptions.data=e},m.$watch("$ctrl.billingserviceData.selected",function(e){angular.isDefined(e)&&c.tabClick(s.tab||"settlereport")}),c}]}),angular.module("app").filter("numberToFixed",function(){return function(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i}});