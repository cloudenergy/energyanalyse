angular.module("app").component("main",{templateUrl:"app/modules/main/main.html?rev=440a1cf73c",controller:["$api","$q",function(t,e){function a(t){var e=new Date;e.setDate(e.getDate()+t);var a=e.getFullYear(),o=e.getMonth()+1,n=e.getDate();return String(a)+String(o<10&&"0"+o||o)+String(n)}var o=this;o.groupmode=!1,o.selectDay=moment().format("YYYYMMDD"),o.selectMonth=moment().format("YYYYMM"),o.projectName=APP.Project[0].title||o.projectName,o.projectid=APP.Project[0]._id,o.today=a(0),o.yesterday=a(-1),o.thisMonth=(new Date).toLocaleString().split(" ")[0].split("/")[0]+(1==(new Date).toLocaleString().split(" ")[0].split("/")[1].length&&"0"+(new Date).toLocaleString().split(" ")[0].split("/")[1]||(new Date).toLocaleString().split(" ")[0].split("/")[1])+"01",o.lastMonthStart=String((new Date).getFullYear())+(1==String((new Date).getMonth()).length&&"0"+String((new Date).getMonth())||String((new Date).getMonth()))+"01",o.lastMonthEnd=String((new Date).getFullYear())+(1==String((new Date).getMonth()).length&&"0"+String((new Date).getMonth())||String((new Date).getMonth()))+String(new Date((new Date).getFullYear(),(new Date).getMonth(),0).getDate()),o.year=String((new Date).getFullYear())+"0101",o.COLDWATERMETER={},o.ELECTRICITYMETER={},o.HEATENERGYMETER={},o.ENERGYMETER={},t.eca.info({projectid:o.projectid,type:"BYCATEGORY"},function(t){var e=t.result;o.categoryArray=[],angular.forEach(e,function(t){o.categoryArray.push(t.id)})}).$promise.finally(function(){var a=[];a.push(t.eca.analysis({nodes:o.categoryArray,projectid:o.projectid,timefrom:o.today,timeto:o.today,timetype:"DAY"},function(t){angular.forEach(t.result,function(t){"COLDWATERMETER"==t.category&&(o.COLDWATERMETER.today=t.data.usagesum,o.COLDWATERMETER.todaycost=t.data.costsum),"ELECTRICITYMETER"==t.category&&(o.ELECTRICITYMETER.today=t.data.usagesum,o.ELECTRICITYMETER.todaycost=t.data.costsum),"HEATENERGYMETER"==t.category&&(o.HEATENERGYMETER.today=t.data.usagesum,o.HEATENERGYMETER.todaycost=t.data.costsum),"ENERGYMETER"==t.category&&(o.ENERGYMETER.today=t.data.usagesum,o.ENERGYMETER.todaycost=t.data.costsum)})}).$promise),a.push(t.eca.analysis({nodes:o.categoryArray,projectid:o.projectid,timefrom:o.yesterday,timeto:o.yesterday,timetype:"DAY"},function(t){angular.forEach(t.result,function(t){"COLDWATERMETER"==t.category&&(o.COLDWATERMETER.yesterday=t.data.usagesum,o.COLDWATERMETER.yesterdaycost=t.data.costsum),"ELECTRICITYMETER"==t.category&&(o.ELECTRICITYMETER.yesterday=t.data.usagesum,o.ELECTRICITYMETER.yesterdaycost=t.data.costsum),"HEATENERGYMETER"==t.category&&(o.HEATENERGYMETER.yesterday=t.data.usagesum,o.HEATENERGYMETER.yesterdaycost=t.data.costsum),"ENERGYMETER"==t.category&&(o.ENERGYMETER.yesterday=t.data.usagesum,o.ENERGYMETER.yesterdaycost=t.data.costsum)})}).$promise),a.push(t.eca.analysis({nodes:o.categoryArray,projectid:o.projectid,timefrom:o.thisMonth,timeto:o.today,timetype:"MONTH"},function(t){angular.forEach(t.result,function(t){"COLDWATERMETER"==t.category&&(o.COLDWATERMETER.thisMonth=t.data.usagesum,o.COLDWATERMETER.thisMonthcost=t.data.costsum),"ELECTRICITYMETER"==t.category&&(o.ELECTRICITYMETER.thisMonth=t.data.usagesum,o.ELECTRICITYMETER.thisMonthcost=t.data.costsum),"HEATENERGYMETER"==t.category&&(o.HEATENERGYMETER.thisMonth=t.data.usagesum,o.HEATENERGYMETER.thisMonthcost=t.data.costsum),"ENERGYMETER"==t.category&&(o.ENERGYMETER.thisMonth=t.data.usagesum,o.ENERGYMETER.thisMonthcost=t.data.costsum)})}).$promise),a.push(t.eca.analysis({nodes:o.categoryArray,projectid:o.projectid,timefrom:o.lastMonthStart,timeto:o.lastMonthEnd,timetype:"MONTH"},function(t){angular.forEach(t.result,function(t){"COLDWATERMETER"==t.category&&(o.COLDWATERMETER.lastMonth=t.data.usagesum,o.COLDWATERMETER.lastMonthcost=t.data.costsum),"ELECTRICITYMETER"==t.category&&(o.ELECTRICITYMETER.lastMonth=t.data.usagesum,o.ELECTRICITYMETER.lastMonthcost=t.data.costsum),"HEATENERGYMETER"==t.category&&(o.HEATENERGYMETER.lastMonth=t.data.usagesum,o.HEATENERGYMETER.lastMonthcost=t.data.costsum),"ENERGYMETER"==t.category&&(o.ENERGYMETER.lastMonth=t.data.usagesum,o.ENERGYMETER.lastMonthcost=t.data.costsum)})}).$promise),a.push(t.eca.analysis({nodes:o.categoryArray,projectid:o.projectid,timefrom:o.year,timeto:o.today,timetype:"YEAR"},function(t){angular.forEach(t.result,function(t){"COLDWATERMETER"==t.category&&(o.COLDWATERMETER.year=t.data.usagesum,o.COLDWATERMETER.yearcost=t.data.costsum),"ELECTRICITYMETER"==t.category&&(o.ELECTRICITYMETER.year=t.data.usagesum,o.ELECTRICITYMETER.yearcost=t.data.costsum),"HEATENERGYMETER"==t.category&&(o.HEATENERGYMETER.year=t.data.usagesum,o.HEATENERGYMETER.yearcost=t.data.costsum),"ENERGYMETER"==t.category&&(o.ENERGYMETER.year=t.data.usagesum,o.ENERGYMETER.yearcost=t.data.costsum)})}).$promise),e.all(a).then(function(){o.coldhot={},o.fee={},o.coldhot.today=new BigDecimal(String(o.HEATENERGYMETER.today||0)).add(new BigDecimal(String(o.ENERGYMETER.today||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.coldhot.yesterday=new BigDecimal(String(o.HEATENERGYMETER.yesterday||0)).add(new BigDecimal(String(o.ENERGYMETER.yesterday||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.coldhot.thisMonth=new BigDecimal(String(o.HEATENERGYMETER.thisMonth||0)).add(new BigDecimal(String(o.ENERGYMETER.thisMonth||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.coldhot.lastMonth=new BigDecimal(String(o.HEATENERGYMETER.lastMonth||0)).add(new BigDecimal(String(o.ENERGYMETER.lastMonth||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.coldhot.year=new BigDecimal(String(o.HEATENERGYMETER.year||0)).add(new BigDecimal(String(o.ENERGYMETER.year||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.fee.today=new BigDecimal(String(o.COLDWATERMETER.todaycost||0)).add(new BigDecimal(String(o.ELECTRICITYMETER.todaycost||0))).add(new BigDecimal(String(o.HEATENERGYMETER.todaycost||0))).add(new BigDecimal(String(o.ENERGYMETER.todaycost||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.fee.yesterdaycost=new BigDecimal(String(o.COLDWATERMETER.yesterdaycost||0)).add(new BigDecimal(String(o.ELECTRICITYMETER.yesterdaycost||0))).add(new BigDecimal(String(o.HEATENERGYMETER.yesterdaycost||0))).add(new BigDecimal(String(o.ENERGYMETER.yesterdaycost||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.fee.thisMonthcost=new BigDecimal(String(o.COLDWATERMETER.thisMonthcost||0)).add(new BigDecimal(String(o.ELECTRICITYMETER.thisMonthcost||0))).add(new BigDecimal(String(o.HEATENERGYMETER.thisMonthcost||0))).add(new BigDecimal(String(o.ENERGYMETER.thisMonthcost||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.fee.lastMonthcost=new BigDecimal(String(o.COLDWATERMETER.lastMonthcost||0)).add(new BigDecimal(String(o.ELECTRICITYMETER.lastMonthcost||0))).add(new BigDecimal(String(o.HEATENERGYMETER.lastMonthcost||0))).add(new BigDecimal(String(o.ENERGYMETER.lastMonthcost||0))).setScale(2,MathContext.ROUND_HALF_UP).toString(),o.fee.yearcost=new BigDecimal(String(o.COLDWATERMETER.yearcost||0)).add(new BigDecimal(String(o.ELECTRICITYMETER.yearcost||0))).add(new BigDecimal(String(o.HEATENERGYMETER.yearcost||0))).add(new BigDecimal(String(o.ENERGYMETER.yearcost||0))).setScale(2,MathContext.ROUND_HALF_UP).toString()})})}]}),angular.module("app").component("mainCalendar",{templateUrl:"app/modules/main/calendar.html",bindings:{groupmode:"<",selectDay:"=",selectMonth:"="},controller:["$scope","$element","$timeout","$api",function(t,e,a,o){var n=this,i=e.find("datetimepicker").on("dp.change",function(t){a(function(){n.selectDay=t.date.format("YYYYMMDD"),n.selectMonth=t.date.format("YYYYMM"),n.bindTD()})}).on("dp.update",function(t){angular.equals(t.viewDate.format("YYYYMM"),n.selectMonth)?n.bindTD():i.data("DateTimePicker").defaultDate(t.viewDate._d)});n.bindTD=function(){n.calendarData&&i.find(".datepicker-days table tbody td.day").each(function(){if(!/old|new/i.test(this.className)){var t=$(this),e=t.data("day"),a="emstatus-keep";n.calendarData.detail[e]>n.calendarData.average&&(a="emstatus-up"),n.calendarData.detail[e]>n.calendarData.average&&(a="emstatus-down"),t.removeClass("emstatus-up").removeClass("emstatus-down").removeClass("emstatus-keep"),n.calendarData.detail[e]&&t.addClass(a)}}),i.find(".datepicker-days table tbody td.active").click(function(){return!1})},t.$watch("$ctrl.selectMonth",function(t){o.business.calendar({time:t,project:APP.Project[0].id,assemble:n.groupmode},function(t){t=n.groupmode?t.result:t.result[APP.Project[0].id],n.calendarData=t||{},n.calendarData.detail=n.calendarData.detail,n.groupmode?n.calendarData.average=n.calendarData.buildingConsumption/(n.calendarData.detail&&Object.keys(n.calendarData.detail).length||0):n.calendarData.average=n.calendarData.buildingConsumption/(n.calendarData.detail&&n.calendarData.detail.length||0),angular.forEach(n.calendarData.detail,function(t,e){n.groupmode?this[moment(1*e).format("YYYY-MM-DD")]=t:this[moment(1*t._id).format("YYYY-MM-DD")]=t.value},n.calendarData.detail={}),n.bindTD()})})}]}),angular.module("app").component("mainDailycost",{templateUrl:"app/modules/main/dailycost.html",bindings:{groupmode:"<",selectDay:"<"},controller:["$api",function(t){var e=this;e.$onChanges=function(){e.showDay=e.selectDay.toString().replace(/^(\d{4})(\d{2})(\d{2})$/,"$1-$2-$3"),t.business.dailycost({time:e.selectDay,project:APP.Project.ids,assemble:e.groupmode},function(t){t=e.groupmode?t.result||{}:t.result[APP.Project[0].id]||{},e.currentDayqoq=Math.round(100*t.qoqPercent)/100,e.currentDayyoy=Math.round(100*t.yoyPercent)/100,e.dailycost={chart:{margin:[0,0,0,0],style:{textAlign:"center"},type:"pie"},title:{text:'<div class="pieTitle">今日费用</div><div class="pieNumber">'+t.cost+'</div><div class="pieUnit">元</div>',verticalAlign:"middle",useHTML:!0,y:-12},tooltip:!1,plotOptions:{pie:{dataLabels:!1,innerSize:"85%"}},series:[{data:[t.cost]}]}})}}]}),angular.module("app").component("mainMonthlykgce",{templateUrl:"app/modules/main/monthlykgce.html",bindings:{groupmode:"<",selectMonth:"<"},controller:["$api",function(t){var e=this;e.$onChanges=function(){e.showDay=e.selectMonth.toString().replace(/^(\d{4})(\d{2})$/,"$1-$2"),t.business.monthlykgce({time:e.selectMonth,project:APP.Project.ids},function(t){var a=[],o=0,n=0,i=0;e.groupmode?(angular.forEach(t.result,function(t,e){this.push([APP.Project[e].title,t.kgce]),o+=t.kgce,n+=t.kgceperunitarea,i+=t.kwhperunitarea},t.detail=[]),a.push({data:t.detail})):(t=t.result[APP.Project[0].id]||{},angular.forEach(t.detail,function(t,e){this.push([e,t])},t.detail=[]),a.push({data:t.detail}),o=t.kgce,n=t.kgceperunitarea,i=t.kwhperunitarea),e.currentMonthKgceperunitarea=Math.round(100*n)/100,e.currentMonthKwhperunitarea=Math.round(100*i)/100,e.monthlykgce={chart:{marginBottom:0,marginLeft:0,marginRight:140,marginTop:0,style:{textAlign:"center"},type:"pie"},title:{text:'<div class="pieTitle">月综合能耗</div><div class="pieNumber">'+Math.round(100*o)/100+'</div><div class="pieUnit">千克煤</div>',verticalAlign:"middle",useHTML:!0,x:-70,y:-12},tooltip:{pointFormat:" <b>{point.y}</b> 千克煤"},plotOptions:{pie:{dataLabels:!1,innerSize:"85%",showInLegend:!0}},legend:{verticalAlign:"middle",layout:"vertical",labelFormatter:function(){return'<div style="text-align:left;">'+Math.round(10*this.percentage)/10+"% "+this.name+'</div><div style="color:#BBB;text-align:left;">'+this.y+"KGce</div>"},itemWidth:100,useHTML:!0,x:140},series:a}})}}]}),angular.module("app").component("air",{templateUrl:"app/modules/main/air.html",bindings:{groupmode:"<",selectDay:"<"},controller:["$api","$ocLazyLoad",function(t,e){var a=e.load(["https://cdn.hcharts.cn/highcharts/highcharts-more.js","https://cdn.hcharts.cn/highcharts/modules/solid-gauge.js"]),o=this;o.$onChanges=function(){a.then(function(){o.showDay=o.selectDay.toString().replace(/^(\d{4})(\d{2})$/,"$1-$2"),t.business.airquality({},function(t){var e=t.result.pm25max;o.air={chart:{type:"gauge",plotBackgroundColor:null,plotBackgroundImage:null,plotBorderWidth:0,plotShadow:!1},title:{text:""},credits:{enabled:!1},pane:{startAngle:-150,endAngle:150,background:[{backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#FFF"],[1,"#333"]]},borderWidth:0,outerRadius:"109%"},{backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,"#333"],[1,"#FFF"]]},borderWidth:1,outerRadius:"107%"},{},{backgroundColor:"#DDD",borderWidth:0,outerRadius:"105%",innerRadius:"103%"}]},yAxis:{min:0,max:500,minorTickInterval:"auto",minorTickWidth:1,minorTickLength:10,minorTickPosition:"inside",minorTickColor:"#666",tickPixelInterval:30,tickWidth:2,tickPosition:"inside",tickLength:10,tickColor:"#666",labels:{step:2,rotation:"auto"},title:{text:"μm/m3"},plotBands:[{from:0,to:50,color:"#00A286"},{from:50,to:100,color:"#FFE300"},{from:100,to:150,color:"#EE9200"},{from:150,to:200,color:"#DD001E"},{from:200,to:300,color:"#74009A"},{from:300,to:400,color:"#89001A"},{from:400,to:500,color:"#89001A"}]},series:[{name:"PM2.5",data:[80],tooltip:{valueSuffix:" μm/m3"}}]},$("#container-pm25").highcharts(window.Highcharts.merge(o.air,function(t){t.renderer.forExport||t.series[0].points[0].update(Number(e))}));var a=$("#container-pm25").highcharts();a&&a.series[0].points[0].update(Number(e))})})}}]}),angular.module("app").component("mainEnergyconstitute",{templateUrl:"app/modules/main/energyconstitute.html",bindings:{selectMonth:"<"},controller:["$api",function(t){var e=this;e.$onChanges=function(){e.showDay=e.selectMonth.toString().replace(/^(\d{4})(\d{2})$/,"$1-$2"),t.business.energyconstitute({time:e.selectMonth,project:APP.Project[0].id},function(t){var a=[],o=[];angular.forEach(t.result[APP.Project[0].id]||{},function(t,e,n){Object.keys(t).length>a.length&&(n=0,a=[]),angular.forEach(t,function(t,e){this.push(t),0===n&&a.push(parseInt(e))},t=[]),o.push({data:t,name:e})}),e.energyconstitute={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:a,labels:{formatter:function(){return moment(this.value).format("M-DD")}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y}元</span>'},series:o}})}}]}),angular.module("app").component("mainDailysensordetail",{templateUrl:"app/modules/main/dailysensordetail.html",bindings:{selectMonth:"<"},controller:["$api",function(t){var e=this;e.$onChanges=function(){t.business.dailysensordetail({time:e.selectMonth,project:APP.Project[0].id},function(t){t=t.result[APP.Project[0].id]||{};var a=0;angular.forEach(t,function(t,e){this.push([e,t]),a+=100*t},t=[]),e.dailysensordetail={chart:{marginLeft:-10,marginRight:200,style:{textAlign:"left"},type:"pie"},title:{text:'<div class="pieTitle">'+e.selectMonth.toString().replace(/^(\d{4})(\d{2})$/,"$1年$2月")+"能耗</div><div>"+a/100+"KWh</div>",verticalAlign:"middle",useHTML:!0,x:-100,y:-5},tooltip:{pointFormat:"<b>{point.y:.2f}kWh {point.percentage:.2f}%</b>"},plotOptions:{pie:{dataLabels:!1,innerSize:"85%",showInLegend:!0}},legend:{align:"center",verticalAlign:"middle",layout:"vertical",labelFormatter:function(){var t=Math.round(10*this.percentage)/10+"% "+this.name,e=Math.round(100*(this.y||0))/100+"kWh";return['<span class="center-block" title="'+t+'">'+t+"</span>",'<span class="center-block text-muted" title="'+e+'">'+e+"</span>"].join("")},itemWidth:200,x:140,useHTML:!0},series:[{cropThreshold:0,turboThreshold:0,data:t}]}})}}]}),angular.module("app").component("mainEnergyeffectiverate",{templateUrl:"app/modules/main/energyeffectiverate.html",bindings:{groupmode:"<",selectMonth:"<"},controller:["$api",function(t){var e=this;e.$onChanges=function(){e.showDay=e.selectMonth.toString().replace(/^(\d{4})(\d{2})$/,"$1-$2"),t.business.energyeffectiverate({time:e.selectMonth,project:APP.Project.ids,assemble:e.groupmode},function(t){var a=[],o=[];angular.forEach(t.result||{},function(t,e,n){Object.keys(t).length>a.length&&(n=0,a=[]),angular.forEach(t,function(t,e){this.push(Math.round(100*t.value)/100),0===n&&a.push(1e3*e)},t=[]),o.push({data:t,name:{now:"本月能效",yoy:"同期能效"}[e]||e})}),e.energyeffectiverate={chart:{type:"spline"},title:!1,xAxis:{type:"datetime",categories:a,labels:{formatter:function(){return moment(this.value).format("M-DD")}}},yAxis:{title:!1},tooltip:{xDateFormat:"%m月%d日",pointFormat:'{series.name}: <span style="color:{point.color};font-weight:700;">{point.y}KWh</span>'},series:o}})}}]}),angular.module("app").component("mainProjectdetail",{templateUrl:"app/modules/main/projectdetail.html",bindings:{selectMonth:"<"},controller:["$api",function(t){var e=this;e.$onChanges=function(){t.business.projectdetail({time:e.selectMonth,project:APP.Project.ids},function(t){angular.forEach(t.result,function(t){t.data=[0,0,0,0,0],t.data[t.ecslevel-1]=t.uaec,this.push({name:t.name,data:t.data})},t.series=[]),e.projectdetail={chart:{type:"bar"},title:!1,xAxis:{categories:["0-1.8 KWh","1.8-3.8 KWh","3.8-5.7 KWh","5.7-7.7 KWh","7.7-∞ KWh"]},yAxis:{title:!1},tooltip:{valueSuffix:" KWh"},legend:{layout:"vertical",align:"right",verticalAlign:"bottom",y:-20,floating:!0,borderWidth:1},series:t.series}})}}]});