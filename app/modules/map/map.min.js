angular.module("app").component("map",{templateUrl:"app/modules/map/map.html?rev=61fcaf8430",controller:["$api","$q","$rootScope","$interval","$timeout","$scope","$element",function(t,e,i,a,o,r,n){function p(t){var e=new Date;e.setDate(e.getDate()+t);var i=e.getFullYear(),a=e.getMonth()+1,o=e.getDate();return String(i)+String(a<10&&"0"+a||a)+String(o<10&&"0"+o||o)}function l(e){var i="";switch(e){case"electricity":i=["ELECTRICITYMETER","MELECTRICITYMETER"];break;case"water":i=["COLDWATERMETER","HOTWATERMETER","ULTRACOLDWATERMETER"];break;case"temperature":i=["TIMERMETER","HEATENERGYMETER","ENERGYMETER"]}i&&t.eca.analysis({nodes:s.ecaInfoNodes,devicetype:i,projectid:g,timefrom:c,timeto:c,timetype:"DAY",detail:!0},function(t){for(var i=0;i<s.buildings.length;i++)if(s.buildings[i].id){for(var a=0;a<t.result.length;a++)if(s.buildings[i].id===String(t.result[a].id)&&(s.buildings[i].tit=t.result[a].title,void 0!==t.result[a].data)){s.buildings[i][e].gross=t.result[a].data.usagesum,s.buildings[i][e].max=0;for(item in t.result[a].data.usage)s.buildings[i][e].max<t.result[a].data.usage[item].value&&(s.buildings[i][e].max=t.result[a].data.usage[item].value)}}else s.buildings[i][e].gross=0,s.buildings[i][e].max=0}).$promise.then(function(){t.eca.analysis({nodes:s.ecaInfoNodes,devicetype:i,projectid:g,timefrom:d,timeto:d,timetype:"DAY",detail:!0},function(t){for(var i,a,o=0;o<s.buildings.length;o++)if(s.buildings[o].id)for(var r=0;r<t.result.length;r++)s.buildings[o].id===String(t.result[r].id)&&t.result[r].data&&(i=s.buildings[o][e].gross?Number(s.buildings[o][e].gross):0,a=t.result[r].data.usagesum?Number(t.result[r].data.usagesum):0,s.buildings[o][e].gains=((i-a)/i).toFixed(2)?0:((i-a)/i).toFixed(2));else s.buildings[o][e].gains=0})})}var s=this,c=p(0),d=p(-1);p(-2);s.showchart=!1,s.buildings=[{position:{top:"-5%",left:"30%"},id:"23612",electricity:{},water:{},temperature:{},wantTo:2,tit:"羽毛球馆"},{position:{top:"-5%",left:"32.8%"},id:"23609",electricity:{},water:{},temperature:{},wantTo:4,tit:"体育馆"},{position:{top:"-5%",left:"30%"},id:"23615",electricity:{},water:{},temperature:{},wantTo:10.5,tit:"3号食堂"},{position:{top:"-5%",left:"27.5%"},id:"24111",electricity:{},water:{},temperature:{},wantTo:13.3,tit:"2号寝室楼"},{position:{top:"-5%",left:"26%"},id:"24104",electricity:{},water:{},temperature:{},wantTo:16,tit:"1号寝室楼"},{position:{top:"-5%",left:"20%"},id:"23604",electricity:{},water:{},temperature:{},wantTo:24,tit:"工程实验中心2"},{position:{top:"-5%",left:"18%"},id:"23607",electricity:{},water:{},temperature:{},wantTo:30,tit:"国交中心"},{position:{top:"-5%",left:"19.5%"},id:"24377",electricity:{},water:{},temperature:{},wantTo:3,tit:"后勤综合管理中心"},{position:{top:"-5%",left:"40%"},id:"23613",electricity:{},water:{},temperature:{},wantTo:12,tit:"1,2号食堂"},{position:{top:"-5%",left:"45.5%"},id:"24114",electricity:{},water:{},temperature:{},wantTo:14,tit:"5号寝室楼"},{position:{top:"-5%",left:"44%"},id:"24113",electricity:{},water:{},temperature:{},wantTo:16,tit:"4号寝室楼"},{position:{top:"-5%",left:"42.2%"},id:"24112",electricity:{},water:{},temperature:{},wantTo:18.7,tit:"3号寝室楼"},{position:{top:"-5%",left:"49.6%"},id:"24117",electricity:{},water:{},temperature:{},wantTo:18,tit:"8号寝室楼"},{position:{top:"-5%",left:"48%"},id:"24116",electricity:{},water:{},temperature:{},wantTo:20.5,tit:"7号寝室楼"},{position:{top:"-5%",left:"46.2%"},id:"24115",electricity:{},water:{},temperature:{},wantTo:23,tit:"6号寝室楼"},{position:{top:"-5%",left:"53.8%"},id:"24119",electricity:{},water:{},temperature:{},wantTo:22.4,tit:"10号寝室楼"},{position:{top:"-5%",left:"52.2%"},id:"24118",electricity:{},water:{},temperature:{},wantTo:25,tit:"9号寝室楼"},{position:{top:"-5%",left:"81.2%"},id:"24119",electricity:{},water:{},temperature:{},wantTo:59.5,tit:"11号寝室楼"},{position:{top:"-5%",left:"79.5%"},id:"24120",electricity:{},water:{},temperature:{},wantTo:63.5,tit:"12号寝室楼"},{position:{top:"-5%",left:"77.5%"},id:"24121",electricity:{},water:{},temperature:{},wantTo:67.5,tit:"13号寝室楼"},{position:{top:"-5%",left:"50%"},id:"23605",electricity:{},water:{},temperature:{},wantTo:28,tit:"医务室"},{position:{top:"-5%",left:"41.2%"},id:"24249",electricity:{},water:{},temperature:{},wantTo:31,tit:"西四教学楼"},{position:{top:"-5%",left:"39.5%"},id:"24248",electricity:{},water:{},temperature:{},wantTo:34.6,tit:"西三教学楼"},{position:{top:"-5%",left:"37.8%"},id:"24247",electricity:{},water:{},temperature:{},wantTo:38,tit:"西二教学楼"},{position:{top:"-5%",left:"35.8%"},id:"24246",electricity:{},water:{},temperature:{},wantTo:42,tit:"西一教学楼"},{position:{top:"-5%",left:"45.5%"},id:"24335",electricity:{},water:{},temperature:{},wantTo:37,tit:"教四教学楼"},{position:{top:"-5%",left:"43%"},id:"24256",electricity:{},water:{},temperature:{},wantTo:42,tit:"教三教学楼"},{position:{top:"-5%",left:"50.8%"},id:"26455",electricity:{},water:{},temperature:{},wantTo:44.2,tit:"图书馆"},{position:{top:"-5%",left:"59%"},id:"24255",electricity:{},water:{},temperature:{},wantTo:47,tit:"教二教学楼"},{position:{top:"-5%",left:"57%"},id:"24254",electricity:{},water:{},temperature:{},wantTo:53,tit:"教一教学楼"},{position:{top:"-5%",left:"65%"},id:"24253",electricity:{},water:{},temperature:{},wantTo:48.5,tit:"东四教学楼"},{position:{top:"-5%",left:"63.5%"},id:"24252",electricity:{},water:{},temperature:{},wantTo:52.5,tit:"东三教学楼"},{position:{top:"-5%",left:"62.2%"},id:"24251",electricity:{},water:{},temperature:{},wantTo:56.7,tit:"东二教学楼"},{position:{top:"-5%",left:"61%"},id:"24250",electricity:{},water:{},temperature:{},wantTo:61.5,tit:"东一教学楼"},{position:{top:"-5%",left:"74%"},id:"23603",electricity:{},water:{},temperature:{},wantTo:77,tit:"工程实训中心1"},{position:{top:"-5%",left:"80%"},id:"25839",electricity:{},water:{},temperature:{},wantTo:53,tit:"4号食堂"},{position:{top:"-5%",left:"69%"},id:"26470",electricity:{},water:{},temperature:{},wantTo:69,tit:"工程实训附属楼"},{position:{top:"-5%",left:"89%"},id:"",electricity:{},water:{},temperature:{},wantTo:89,tit:"东大门"},{position:{top:"-5%",left:"72.7%"},id:"",electricity:{},water:{},temperature:{},wantTo:57,tit:"湖心广场 B"},{position:{top:"-5%",left:"18.6%"},id:"",electricity:{},water:{},temperature:{},wantTo:20.5,tit:"工具间"},{position:{top:"-5%",left:"34%"},id:"",electricity:{},water:{},temperature:{},wantTo:19,tit:"湖心广场 A"},{position:{top:"-5%",left:"34.5%"},id:"23598",electricity:{},water:{},temperature:{},wantTo:26,tit:"行政楼"},{position:{top:"-5%",left:"25.3%"},id:"28541",electricity:{},water:{},temperature:{},wantTo:34,tit:"操场1"},{position:{top:"-5%",left:"51.8%"},id:"",electricity:{},water:{},temperature:{},wantTo:29.5,tit:"调控室"},{position:{top:"-5%",left:"47%"},id:"",electricity:{},water:{},temperature:{},wantTo:36,tit:"阶四教室"},{position:{top:"-5%",left:"39.6%"},id:"24335",electricity:{},water:{},temperature:{},wantTo:45.5,tit:"阶三教室"},{position:{top:"-5%",left:"60.5%"},id:"",electricity:{},water:{},temperature:{},wantTo:46.5,tit:"阶二教室"},{position:{top:"-5%",left:"57%"},id:"",electricity:{},water:{},temperature:{},wantTo:59.5,tit:"阶一教室"},{position:{top:"-5%",left:"34%"},id:"26469",electricity:{},water:{},temperature:{},wantTo:48.5,tit:"西地下车库"},{position:{top:"-5%",left:"52%"},id:"25852",electricity:{},water:{},temperature:{},wantTo:63.5,tit:"东地下车库"},{position:{top:"-5%",left:"40.5%"},id:"",electricity:{},water:{},temperature:{},wantTo:63,tit:"南大门1"},{position:{top:"-5%",left:"45.2%"},id:"",electricity:{},water:{},temperature:{},wantTo:67.5,tit:"南大门2"},{position:{top:"-5%",left:"49%"},id:"23611",electricity:{},water:{},temperature:{},wantTo:14,tit:"商业街"},{position:{top:"-5%",left:"28%"},id:"23610",electricity:{},water:{},temperature:{},wantTo:.5,tit:"游泳馆"},{position:{top:"-5%",left:"60%"},id:"26471",electricity:{},water:{},temperature:{},wantTo:31,tit:"学生活动中心A"},{position:{top:"-5%",left:"64%"},id:"26472",electricity:{},water:{},temperature:{},wantTo:36,tit:"学生活动中心B"},{position:{top:"-5%",left:"65%"},id:"",electricity:{},water:{},temperature:{},wantTo:30,tit:"北大门"},{position:{top:"-5%",left:"53.6%"},id:"23601",electricity:{},water:{},temperature:{},wantTo:73.5,tit:"基建处"}];var u=-1,m=a(function(){u++,u>=s.buildings.length-1&&(a.cancel(m),s.jumpTime=a(function(){var t=Math.floor(Math.random()*s.buildings.length),e=s.buildings[t].position,i=parseFloat(e.top),a=i;e.top=a-5+"%",o(function(){e.top=i+"%"},200)},3e3)),s.buildings[u].position.top=s.buildings[u].wantTo+"%"},100);s.showdata=function(t,e){t.showdetail=!t.showdetail,t.showdetail||s.showchart?a.cancel(s.jumpTime):(s.jumpTime=a(function(){var t=Math.floor(Math.random()*s.buildings.length),e=s.buildings[t].position,i=parseFloat(e.top),a=i;e.top=a-5+"%",o(function(){e.top=i+"%"},200)},3e3),r.$on("$destroy",function(){a.cancel(s.jumpTime)}))},r.$on("$destroy",function(){a.cancel(s.jumpTime)});var g=APP.Project[0]._id;s.id=[];s.ecaInfoNodes=[];for(var w=0;w<s.buildings.length;w++)s.buildings[w].id&&s.ecaInfoNodes.push(s.buildings[w].id);l("electricity"),l("water"),l("temperature"),s.chartInit=function(t){s.categories=[],s.chartDataLoadingId="",s.tableType={s:!0,d:!0,l:!0},s.timeType="DAY",s.chartDataLoading(t)},s.chartDataLoading=function(e){s.deviceType=[],s.categories=[],s.columnColor=[],e&&(s.tableType.d&&t.eca.analysis({nodes:[e],devicetype:["ELECTRICITYMETER","MELECTRICITYMETER"],projectid:APP.Project[0]._id,timefrom:c,timeto:c,timetype:s.timeType,detail:!0},function(t){var e,i,a,o,r,n=[];for(item in t.result[0].data.usage){if(e=new Date(parseInt(item))){switch(i=e.getHours()<10?"0"+e.getHours()+":00":e.getHours()+":00",a=e.getDate()<10?"0"+e.getDate()+"日":e.getDate()+"日",o=e.getMonth()+1<10?"0"+(e.getMonth()+1)+"月":e.getMonth()+1+"月",r=e.getFullYear()+"年",s.timeType){case"DAY":pushY=i;break;case"MONTH":pushY=o+a;break;case"YEAR":pushY=r+o}s.categories.push(pushY)}n.push(t.result[0].data.usage[item].value)}s.deviceType.push({name:"电",data:n,_colorIndex:2}),s.typeChange(s.charttype)}),s.tableType.s&&t.eca.analysis({nodes:[e],devicetype:["COLDWATERMETER","HOTWATERMETER","ULTRACOLDWATERMETER"],projectid:APP.Project[0]._id,timefrom:c,timeto:c,timetype:s.timeType,detail:!0},function(t){var e=[];for(item in t.result[0].data.usage){if(date=new Date(parseInt(item)),date){switch(getH=date.getHours()<10?"0"+date.getHours()+":00":date.getHours()+":00",getD=date.getDate()<10?"0"+date.getDate()+"日":date.getDate()+"日",getM=date.getMonth()+1<10?"0"+(date.getMonth()+1)+"月":date.getMonth()+1+"月",getY=date.getFullYear()+"年",s.timeType){case"DAY":pushY=getH;break;case"MONTH":pushY=getM+getD;break;case"YEAR":pushY=getY+getM}s.categories.push(pushY)}e.push(t.result[0].data.usage[item].value)}s.deviceType.push({name:"水",data:e,_colorIndex:1}),s.typeChange(s.charttype)}),s.tableType.l&&t.eca.analysis({nodes:[e],devicetype:["TIMERMETER","HEATENERGYMETER","ENERGYMETER"],projectid:APP.Project[0]._id,timefrom:c,timeto:c,timetype:s.timeType,detail:!0},function(t){var e=[];for(item in t.result[0].data.usage){if(date=new Date(parseInt(item)),date){switch(getH=date.getHours()<10?"0"+date.getHours()+":00":date.getHours()+":00",getD=date.getDate()<10?"0"+date.getDate()+"日":date.getDate()+"日",getM=date.getMonth()+1<10?"0"+(date.getMonth()+1)+"月":date.getMonth()+1+"月",getY=date.getFullYear()+"年",s.timeType){case"DAY":pushY=getH;break;case"MONTH":pushY=getM+getD;break;case"YEAR":pushY=getY+getM}s.categories.push(pushY)}e.push(t.result[0].data.usage[item].value)}s.deviceType.push({name:"冷热量",data:e,_colorIndex:0}),s.typeChange(s.charttype)})),s.typeChange(s.charttype)},t.eca.info({projectid:APP.Project[0]._id},function(t){console.log(t)}),s.charttype="column",s.typeChange=function(t){t&&(s.charttype=t),s.energyconstitute={colors:["#76cb2e","#00c4e9","#fd7a2b"],chart:{type:s.charttype,backgroundColor:"rgba(0, 0, 0, 0)",height:700},title:!1,xAxis:{categories:s.categories,labels:{style:{color:"#fff"}}},yAxis:{title:!1,labels:{style:{color:"#fff"}}},tooltip:{formatter:function(){var t;switch(this.series.name){case"水":t=" m³";break;case"电":case"冷热度":t=" Wkh"}return"<b>"+this.x+"</b><br>"+this.series.name+': <span style="color:#333;font-weight:700;">'+this.y+t+"</span>"}},plotOptions:{series:{borderWidth:0,dataLabels:{enabled:!0}}},legend:{itemStyle:{color:"#fff"},itemHoverStyle:{color:"#fff"}},series:s.deviceType}},s.tableTypeSwitch=function(t){switch(t){case"$ctrl.tableType.s":s.tableType.s?s.tableType.s=!1:s.tableType.s=!0;break;case"$ctrl.tableType.d":s.tableType.d?s.tableType.d=!1:s.tableType.d=!0;break;case"$ctrl.tableType.l":s.tableType.l?s.tableType.l=!1:s.tableType.l=!0}s.chartDataLoading(s.chartDataLoadingId)},s.timeTypeSwitch=function(t){s.timeType=t,s.chartDataLoading(s.chartDataLoadingId)}}]});